<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
  <!--
     You can run this change log on your database as many times as you want, it will ignore the
     changes that are already applied. It also means that you can't modify an existing revision.
     Always add to the end.

     Use the maven goals: liquibase:update and liquibase:status
      Potentially with -Dliquibase.dropFirst=true
 -->
  <property name="uniqueid.size" value="22"/> <!-- size of a UUID is 36. Current key length is 22 -->
  <property name="userid.size" value="40"/>

  <changeSet author="roug" id="rev-1">
    <comment>Dataset metadata</comment>
    <createTable tableName="datasets"> <!-- Should be called editions -->
      <column name="editionId" type="varchar(${uniqueid.size})">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="filename" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="uploader" type="varchar(${userid.size})">
        <constraints nullable="false"/>
      </column>
      <column name="contenttype" type="varchar(80)"/>
      <column name="filesize" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="familyid" type="varchar(${uniqueid.size})">
        <constraints nullable="false"/>
      </column>
      <column name="uploadtime" type="datetime">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <!--
    <modifySql dbms="mysql">
      <append value=" ENGINE=InnoDB DEFAULT CHARSET=utf8"/>
    </modifySql>
    -->
    <createIndex indexName="idx_familyid"
        tableName="datasets"
        unique="false">
      <column name="familyid"/>
    </createIndex>
  </changeSet>

  <changeSet id="rev-2" author="roug">
    <comment>Authorisations</comment>
  <!--
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="authorities"/>
      </not>
    </preConditions>
  -->
    <createTable tableName="users">
      <column name="username" type="varchar(${userid.size})">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="password" type="varchar(40)"/>
      <column name="enabled" type="boolean"/>
    </createTable>

    <createTable tableName="authorities">
      <column name="username" type="varchar(${userid.size})">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="authority" type="varchar(40)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="rev-3" author="roug">
    <comment>Tests on datasets</comment>
    <createTable tableName="qatests">
      <column name="testid" type="int" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="familyid" type="varchar(${uniqueid.size})">
        <constraints nullable="false"/>
      </column>
      <column name="testtype" type="varchar(20)">
        <constraints nullable="false"/>
      </column>
      <column name="query" type="text">
        <constraints nullable="false"/>
      </column>
      <column name="expectedresult" type="text"/>
    </createTable>

    <addForeignKeyConstraint
        constraintName="fk_datasets_familyid"
        baseTableName="qatests"
        baseColumnNames="familyid"
        referencedTableName="datasets"
        referencedColumnNames="familyid"
        onDelete="CASCADE" onUpdate="CASCADE"/>
  </changeSet>

  <changeSet id="rev-4" author="roug">
    <comment>Families of datasets - should be called datasets</comment>
    <createTable tableName="families">
      <column name="familyid" type="varchar(${uniqueid.size})">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="keep" type="int" remarks="Generations to keep of uploaded editions. NULL is infinite">
        <constraints nullable="true"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="rev-5" author="roug">
    <comment>Test results</comment>
    <createTable tableName="testresults">
      <column name="testid" type="int" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="editionid" type="varchar(${uniqueid.size})">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="passed" type="boolean" remarks="True if test passed">
        <constraints nullable="false"/>
      </column>
      <column name="testran" type="datetime">
        <constraints nullable="false"/>
      </column>
      <column name="result" type="text">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
</databaseChangeLog>
